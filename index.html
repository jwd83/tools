<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Jared's Tools Desktop</title>
  <link rel="icon" type="image/svg+xml" href="./favicon.svg" />
  <link rel="shortcut icon" href="./favicon.svg" />
  <style>
    :root {
      --panel-bg: #e5e5e5;
      --panel-border: #000;
      --desktop-dark: #888;
      --desktop-mid: #a9a9a9;
      --desktop-light: #c4c4c4;
      --window-bg: #f1f1f1;
      --window-border: #000;
      --title-active-start: #f3f3f3;
      --title-active-end: #dcdcdc;
      --title-inactive-start: #ececec;
      --title-inactive-end: #e2e2e2;
      --text-dark: #101010;
      --shadow: rgba(0, 0, 0, 0.2);
      --icon-size: 58px;
    }

    * {
      box-sizing: border-box;
    }

    html,
    body {
      margin: 0;
      width: 100%;
      height: 100%;
      font-family: "Geneva", "Helvetica", "Arial", sans-serif;
      color: var(--text-dark);
      overflow: hidden;
      user-select: none;
    }

    body {
      background:
        radial-gradient(circle at 16% 10%, rgba(255, 255, 255, 0.35), transparent 45%),
        linear-gradient(160deg, var(--desktop-dark) 0%, var(--desktop-mid) 48%, var(--desktop-light) 100%);
      position: relative;
    }

    body::after {
      content: "";
      position: absolute;
      inset: 0;
      pointer-events: none;
      background-image: radial-gradient(rgba(0, 0, 0, 0.22) 0.6px, transparent 0.6px);
      background-size: 2px 2px;
      opacity: 0.32;
    }

    #desktop-shell {
      position: relative;
      width: 100%;
      height: 100%;
      display: grid;
      grid-template-rows: 36px 1fr 44px;
      z-index: 1;
    }

    .panel {
      border: 2px solid var(--panel-border);
      background: linear-gradient(#f7f7f7, var(--panel-bg));
      box-shadow: inset 0 1px #fff;
      display: flex;
      align-items: center;
      padding: 0 10px;
      gap: 10px;
      font-size: 14px;
      font-weight: 700;
    }

    .panel-top {
      border-width: 0 0 2px;
    }

    .panel-menu {
      display: flex;
      gap: 4px;
    }

    .menu-item {
      border: 1px solid transparent;
      padding: 3px 7px;
      cursor: default;
      line-height: 1;
    }

    .menu-item:hover {
      border-color: #000;
      background: #000;
      color: #fff;
    }

    .menu-apple {
      font-size: 16px;
      font-weight: 700;
      padding-inline: 8px;
    }

    .panel-title {
      margin-inline: auto;
      color: #1e1e1e;
      font-weight: 700;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      text-align: center;
      max-width: 45%;
    }

    .panel-clock {
      min-width: 160px;
      text-align: right;
      font-variant-numeric: tabular-nums;
      color: #171717;
      font-weight: 700;
    }

    #desktop {
      position: relative;
      width: 100%;
      height: 100%;
      overflow: hidden;
      padding: 18px;
    }

    .desktop-icons {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 16px 10px;
      max-width: 720px;
      pointer-events: auto;
    }

    .desktop-icon {
      width: 100px;
      border: 1px solid transparent;
      background: transparent;
      color: var(--text-dark);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      padding: 8px 6px;
      cursor: default;
      outline: none;
    }

    .desktop-icon:hover,
    .desktop-icon:focus-visible {
      border-color: #000;
      background:
        linear-gradient(45deg, rgba(0, 0, 0, 0.12) 25%, transparent 25%) 0 0 / 4px 4px,
        linear-gradient(-45deg, rgba(0, 0, 0, 0.08) 25%, transparent 25%) 0 0 / 4px 4px,
        rgba(255, 255, 255, 0.35);
    }

    .desktop-icon img {
      width: var(--icon-size);
      height: var(--icon-size);
      background: rgba(255, 255, 255, 0.7);
      border: 2px solid #000;
      padding: 6px;
      object-fit: contain;
      box-shadow: inset 1px 1px #fff;
      pointer-events: none;
    }

    .desktop-icon span {
      text-align: center;
      font-size: 12px;
      line-height: 1.25;
      width: 100%;
      word-break: break-word;
    }

    .window-layer {
      position: absolute;
      inset: 0;
      pointer-events: none;
    }

    .app-window {
      position: absolute;
      width: min(540px, calc(100vw - 48px));
      height: min(400px, calc(100vh - 130px));
      min-width: 320px;
      min-height: 220px;
      border: 2px solid var(--window-border);
      background: var(--window-bg);
      box-shadow: 5px 5px 0 var(--shadow);
      display: grid;
      grid-template-rows: 34px 1fr;
      overflow: visible;
      pointer-events: auto;
    }

    .app-window.inactive .window-titlebar {
      background: linear-gradient(var(--title-inactive-start), var(--title-inactive-end));
    }

    .window-titlebar {
      background: linear-gradient(var(--title-active-start), var(--title-active-end));
      color: #000;
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 0 4px;
      font-size: 13px;
      border-bottom: 2px solid #000;
      cursor: move;
    }

    .title-icon {
      width: 15px;
      height: 15px;
      background: #fff;
      border: 2px solid #000;
      object-fit: contain;
      flex: 0 0 auto;
    }

    .window-title {
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-weight: 700;
      background: #efefef;
      border-top: 2px solid #000;
      border-bottom: 2px solid #000;
      line-height: 1.3;
      padding: 0 8px;
      text-align: center;
    }

    .window-actions {
      display: flex;
      align-items: center;
      gap: 4px;
      margin-left: auto;
    }

    .win-btn {
      width: 16px;
      height: 16px;
      border: 2px solid #000;
      background: #fff;
      color: #111;
      font-size: 9px;
      font-weight: 700;
      line-height: 1;
      padding: 0;
      cursor: pointer;
      display: grid;
      place-items: center;
    }

    .win-btn:hover {
      background: #000;
      color: #fff;
    }

    .window-content {
      position: relative;
      background: #fff;
      overflow: hidden;
    }

    .window-content iframe {
      width: 100%;
      height: 100%;
      border: 0;
      background: #fff;
    }

    .window-resizer {
      position: absolute;
      z-index: 6;
      touch-action: none;
    }

    .window-resizer-right {
      top: 0;
      right: -12px;
      width: 24px;
      bottom: 0;
      cursor: ew-resize;
    }

    .window-resizer-bottom {
      left: 0;
      right: 0;
      bottom: -12px;
      height: 24px;
      cursor: ns-resize;
    }

    .window-resizer-corner {
      right: -12px;
      bottom: -12px;
      width: 34px;
      height: 34px;
      cursor: nwse-resize;
      border-top: 2px solid #000;
      border-left: 2px solid #000;
      background:
        repeating-linear-gradient(45deg, #f8f8f8 0 2px, #d6d6d6 2px 4px);
      z-index: 7;
    }

    .panel-bottom {
      border-width: 2px 0 0;
      gap: 8px;
      padding: 4px 8px;
    }

    .start-button {
      border: 2px solid #000;
      background: linear-gradient(#fff, #e1e1e1);
      padding: 4px 10px;
      display: inline-flex;
      align-items: center;
      gap: 7px;
      font-size: 13px;
      font-weight: 700;
      min-width: 96px;
    }

    .start-button img {
      width: 14px;
      height: 14px;
      object-fit: contain;
    }

    .task-buttons {
      display: flex;
      gap: 6px;
      overflow-x: auto;
      scrollbar-width: thin;
      flex: 1;
      min-width: 0;
    }

    .task-button {
      border: 2px solid #000;
      background: linear-gradient(#fff, #e9e9e9);
      color: #111;
      font-size: 12px;
      padding: 4px 9px;
      max-width: 210px;
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
      cursor: pointer;
    }

    .task-button.active {
      background: #000;
      border-color: #000;
      color: #fff;
    }

    .desktop-credit {
      font-size: 12px;
      color: #111;
      white-space: nowrap;
    }

    .desktop-credit a {
      color: #111;
      text-decoration: none;
    }

    @media (max-width: 900px) {
      #desktop-shell {
        grid-template-rows: 36px 1fr 52px;
      }

      .panel-title {
        display: none;
      }

      .panel-clock {
        min-width: 104px;
        font-size: 12px;
      }

      .desktop-icons {
        grid-template-columns: repeat(auto-fill, minmax(86px, 1fr));
        max-width: none;
      }

      .desktop-icon {
        width: auto;
      }

      .app-window {
        width: min(96vw, 520px);
        height: min(56vh, 400px);
      }

      .desktop-credit {
        display: none;
      }
    }
  </style>
</head>

<body>
  <div id="desktop-shell">
    <header class="panel panel-top" role="banner">
      <div class="panel-menu" aria-label="Menu strip">
        <span class="menu-item menu-apple" aria-label="Apple menu">&#63743;</span>
        <span class="menu-item">File</span>
        <span class="menu-item">Edit</span>
        <span class="menu-item">Find</span>
        <span class="menu-item">Window</span>
        <span class="menu-item">Tools</span>
      </div>
      <div class="panel-title">Jared's Tools Desktop</div>
      <div class="panel-clock" id="panel-clock" aria-live="polite"></div>
    </header>

    <main id="desktop">
      <section class="desktop-icons" id="desktop-icons" aria-label="Desktop icons"></section>
      <section class="window-layer" id="window-layer" aria-label="Open windows"></section>
    </main>

    <footer class="panel panel-bottom">
      <button class="start-button" type="button" aria-label="Launcher">
        <img src="./favicon.svg" alt="" />
        <span>Tools</span>
      </button>
      <div class="task-buttons" id="task-buttons" aria-label="Open window buttons"></div>
      <div class="desktop-credit">
        <a href="https://jwd.me">jwd.me</a> |
        <a href="https://github.com/jwd83/tools">source</a>
      </div>
    </footer>
  </div>

  <script>
    const tools = [
      {
        title: "LeftRight Audio Test",
        description: "Test your speakers or headphones with left/right audio channels.",
        link: "https://leftright.jwd.me",
        category: "Audio & Music",
      },
      {
        title: "Gamepad Tester",
        description: "Check your gamepad or controller inputs in real time.",
        link: "https://gamepad.jwd.me",
        category: "Games & Input",
      },
      {
        title: "Shrink - Image Resizer",
        description: "Shrink large images so they are small enough to upload to Discord or other sites.",
        link: "https://shrink.jwd.me",
        category: "Image & Media",
      },
      {
        title: "Blur - Image Blur/Blackout",
        description: "Blur or blackout sensitive/spoiler areas in images directly in your browser.",
        link: "https://blur.jwd.me/",
        category: "Image & Media",
      },
      {
        title: "Croppy - Square 640 Image Cropper",
        description: "Crop your images to a perfect square 640x640 format usable by Wan/ComfyUI.",
        link: "https://jwd83.github.io/croppy/",
        category: "Image & Media",
      },
      {
        title: "Mic FFT Visualizer",
        description: "Visualize your microphone input in real-time using Fast Fourier Transform (FFT).",
        link: "https://jwd83.github.io/mic-fft/",
        category: "Audio & Music",
      },
      {
        title: "URL Cleaner",
        description: "Strip tracking and extra noise from URLs to make them easier to share.",
        link: "https://jwd83.github.io/cleaner/",
        category: "Text & Utility",
      },
      {
        title: "Ping Test",
        description: "Test ping and latency to check your connection quickly.",
        link: "https://ping.jwd.me/",
        category: "Text & Utility",
      },
      {
        title: ".torrent to Magnet Link",
        description: "Generate magnet links from torrent files for easy sharing and downloading.",
        link: "https://magneto.jwd.me/",
        category: "Text & Utility",
      },
      {
        title: "Snake Game",
        description: "Classic Snake game you can play in your browser.",
        link: "https://jwd83.github.io/snake/",
        category: "Games & Input",
      },
      {
        title: "GitHubPie",
        description: "See a pie chart of a user's github language use.",
        link: "https://jwd83.github.io/githubpie/",
        category: "Text & Utility",
      },
      {
        title: "QR Link Generator",
        description: "Chrome extension to locally/offline generate QR codes from URLs for easy sharing.",
        link: "https://github.com/jwd83/qrl",
        category: "Image & Media",
      },
      {
        title: "PDF Merge",
        description: "Merge multiple PDF files into a single document directly in your browser.",
        link: "https://jwd83.github.io/pdfmerge/",
        category: "Image & Media",
      },
      {
        title: "Chromatic Keyboard",
        description: "A virtual C major keyboard supporting 3 octaves. Bring your own sample!",
        link: "https://jwd83.github.io/chromatickeyboard/",
        category: "Audio & Music",
      },
      {
        title: "Chromatic Tuner",
        description: "Tune your guitar, violin, etc. using your device's microphone.",
        link: "https://tuner.jwd.me/",
        category: "Audio & Music",
      },
      {
        title: "Xfer - Simple file sharing!",
        description: "P2P encrypted file sharing with no uploads, no tracking, and no ads.",
        link: "https://xfer.jwd.me/",
        category: "Text & Utility",
      },
      {
        title: "Plyground - In browser Python REPL",
        description: "Run Python code directly in your browser with a REPL interface.",
        link: "https://jwd83.github.io/plyground/",
        category: "Text & Utility",
      },
      {
        title: "Hash Generator",
        description: "Generate various types of hashes (SHA-256, SHA3, etc.) from your input file.",
        link: "https://hash.jwd.me/",
        category: "Text & Utility",
      },
      {
        title: "Markdown Editor",
        description: "Basic in-browser markdown editor with preview.",
        link: "https://md.jwd.me/",
        category: "Text & Utility",
      },
      {
        title: "Binary Differ",
        description: "A simple in-browser binary diff tool.",
        link: "https://bindiff.jwd.me/",
        category: "Text & Utility",
      },
      {
        title: "Weather",
        description: "A simple weather app designed by GLM and GPT.",
        link: "https://weather.jwd.me/",
        category: "Misc",
      },
      {
        title: "Gridlines",
        description: "Make crochet and knitting pattern lines.",
        link: "https://gridlines.jwd.me/",
        category: "Misc",
      },
      {
        title: "Emoji Favicon Generator",
        description: "Generate a favicon from any emoji in your browser.",
        link: "https://favicon.jwd.me/",
        category: "Image & Media",
      },
    ];

    const experimentalTools = [];

    const allTools = [
      ...tools.map((tool) => ({ ...tool, experimental: false })),
      ...experimentalTools.map((tool) => ({ ...tool, category: "Experimental", experimental: true })),
    ];

    const desktopIcons = document.getElementById("desktop-icons");
    const windowLayer = document.getElementById("window-layer");
    const taskButtons = document.getElementById("task-buttons");
    const panelClock = document.getElementById("panel-clock");
    const fallbackIcon = "./favicon.svg";
    let topZIndex = 30;
    let openCount = 0;
    const windowMap = new Map();
    const faviconRuntimeCache = new Map();
    const faviconPromiseCache = new Map();

    function faviconScope(url) {
      const parsed = new URL(url);
      const path = parsed.pathname.endsWith("/") ? parsed.pathname : `${parsed.pathname}/`;
      return `${parsed.origin}${path}`;
    }

    function faviconCacheKey(scope) {
      return `tools:favicon:v2:${encodeURIComponent(scope)}`;
    }

    function getCachedFavicon(scope) {
      try {
        return localStorage.getItem(faviconCacheKey(scope));
      } catch {
        return null;
      }
    }

    function setCachedFavicon(scope, iconUrl) {
      try {
        localStorage.setItem(faviconCacheKey(scope), iconUrl);
      } catch {
      }
    }

    function clearCachedFavicon(scope) {
      try {
        localStorage.removeItem(faviconCacheKey(scope));
      } catch {
      }
    }

    function faviconCandidates(url) {
      const { hostname: host, origin, pathname } = new URL(url);
      const path = pathname.endsWith("/") ? pathname : `${pathname}/`;
      const projectBase = `${origin}${path}`;

      return [...new Set([
        `${projectBase}favicon.svg`,
        `${projectBase}favicon.ico`,
        `${projectBase}favicon.png`,
        `${origin}/favicon.svg`,
        `${origin}/favicon.ico`,
        `${origin}/favicon.png`,
        `${origin}/apple-touch-icon.png`,
        `https://icons.duckduckgo.com/ip3/${host}.ico`,
        `https://www.google.com/s2/favicons?domain=${host}&sz=128`,
      ])];
    }

    function preloadImage(url) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.decoding = "async";
        img.referrerPolicy = "no-referrer";
        img.onload = () => resolve(url);
        img.onerror = () => reject(new Error(`Icon load failed: ${url}`));
        img.src = url;
      });
    }

    function resolveFavicon(url) {
      let scope = "";
      try {
        scope = faviconScope(url);
      } catch {
        return Promise.resolve(fallbackIcon);
      }

      if (faviconRuntimeCache.has(scope)) {
        const runtimeIcon = faviconRuntimeCache.get(scope);
        if (runtimeIcon && runtimeIcon !== fallbackIcon) {
          return Promise.resolve(runtimeIcon);
        }
        faviconRuntimeCache.delete(scope);
      }

      if (faviconPromiseCache.has(scope)) {
        return faviconPromiseCache.get(scope);
      }

      const pendingResolution = (async () => {
        const { origin } = new URL(scope);
        const cachedIcon = getCachedFavicon(scope);
        if (cachedIcon && cachedIcon.startsWith(origin)) {
          try {
            await preloadImage(cachedIcon);
            faviconRuntimeCache.set(scope, cachedIcon);
            return cachedIcon;
          } catch {
            clearCachedFavicon(scope);
          }
        } else if (cachedIcon) {
          clearCachedFavicon(scope);
        }

        const candidates = faviconCandidates(url);
        for (const iconUrl of candidates) {
          try {
            await preloadImage(iconUrl);
            faviconRuntimeCache.set(scope, iconUrl);
            setCachedFavicon(scope, iconUrl);
            return iconUrl;
          } catch {
          }
        }
        faviconRuntimeCache.set(scope, fallbackIcon);
        return fallbackIcon;
      })();

      faviconPromiseCache.set(scope, pendingResolution);
      pendingResolution.finally(() => {
        faviconPromiseCache.delete(scope);
      });

      return pendingResolution;
    }

    function applyResolvedFavicon(imageEl, toolUrl) {
      imageEl.src = fallbackIcon;
      resolveFavicon(toolUrl).then((iconUrl) => {
        imageEl.src = iconUrl || fallbackIcon;
      });
    }

    function updateClock() {
      const now = new Date();
      const clock = now.toLocaleTimeString([], {
        hour: "2-digit",
        minute: "2-digit",
        second: "2-digit",
      });
      const day = now.toLocaleDateString([], {
        weekday: "short",
        month: "short",
        day: "numeric",
      });
      panelClock.textContent = `${day} ${clock}`;
    }

    function setActiveWindow(windowId) {
      windowMap.forEach((entry, id) => {
        const isActive = id === windowId;
        entry.window.classList.toggle("inactive", !isActive);
        entry.taskButton.classList.toggle("active", isActive);
      });

      const active = windowMap.get(windowId);
      if (active) {
        topZIndex += 1;
        active.window.style.zIndex = String(topZIndex);
      }
    }

    function removeWindow(windowId) {
      const entry = windowMap.get(windowId);
      if (!entry) {
        return;
      }

      entry.window.remove();
      entry.taskButton.remove();
      windowMap.delete(windowId);

      const newest = [...windowMap.values()]
        .sort((a, b) => Number(b.window.style.zIndex || 0) - Number(a.window.style.zIndex || 0))[0];
      if (newest) {
        setActiveWindow(newest.id);
      }
    }

    function toggleMinimize(windowId) {
      const entry = windowMap.get(windowId);
      if (!entry) {
        return;
      }

      const isHidden = entry.window.style.display === "none";
      entry.window.style.display = isHidden ? "grid" : "none";
      if (isHidden) {
        setActiveWindow(windowId);
      } else {
        entry.taskButton.classList.remove("active");
      }
    }

    function attachDrag(windowEl, dragHandle) {
      let dragState = null;

      const onPointerMove = (event) => {
        if (!dragState) {
          return;
        }

        const desktopRect = document.getElementById("desktop").getBoundingClientRect();
        const maxLeft = desktopRect.width - windowEl.offsetWidth;
        const maxTop = desktopRect.height - windowEl.offsetHeight;
        const left = Math.min(Math.max(0, event.clientX - dragState.offsetX), Math.max(0, maxLeft));
        const top = Math.min(Math.max(0, event.clientY - desktopRect.top - dragState.offsetY), Math.max(0, maxTop));
        windowEl.style.left = `${left}px`;
        windowEl.style.top = `${top}px`;
      };

      const onPointerUp = () => {
        dragState = null;
        document.removeEventListener("pointermove", onPointerMove);
        document.removeEventListener("pointerup", onPointerUp);
      };

      dragHandle.addEventListener("pointerdown", (event) => {
        if (event.target.closest(".win-btn")) {
          return;
        }

        const rect = windowEl.getBoundingClientRect();
        const desktopTop = document.getElementById("desktop").getBoundingClientRect().top;
        dragState = {
          offsetX: event.clientX - rect.left,
          offsetY: event.clientY - rect.top,
        };
        setActiveWindow(windowEl.dataset.windowId);
        document.addEventListener("pointermove", onPointerMove);
        document.addEventListener("pointerup", onPointerUp);

        const currentTop = rect.top - desktopTop;
        windowEl.style.top = `${currentTop}px`;
      });
    }

    function attachResize(windowEl, resizeHandles) {
      let resizeState = null;

      const onPointerMove = (event) => {
        if (!resizeState) {
          return;
        }

        const desktopRect = document.getElementById("desktop").getBoundingClientRect();
        const maxWidth = desktopRect.width - resizeState.left;
        const maxHeight = desktopRect.height - resizeState.top;
        if (resizeState.mode === "right" || resizeState.mode === "corner") {
          const nextWidth = Math.max(320, Math.min(maxWidth, resizeState.startWidth + (event.clientX - resizeState.startX)));
          windowEl.style.width = `${nextWidth}px`;
        }

        if (resizeState.mode === "bottom" || resizeState.mode === "corner") {
          const nextHeight = Math.max(220, Math.min(maxHeight, resizeState.startHeight + (event.clientY - resizeState.startY)));
          windowEl.style.height = `${nextHeight}px`;
        }
      };

      const onPointerUp = () => {
        resizeState = null;
        document.removeEventListener("pointermove", onPointerMove);
        document.removeEventListener("pointerup", onPointerUp);
      };

      resizeHandles.forEach((handle) => {
        handle.addEventListener("pointerdown", (event) => {
          event.preventDefault();
          event.stopPropagation();
          const rect = windowEl.getBoundingClientRect();
          const desktopRect = document.getElementById("desktop").getBoundingClientRect();
          windowEl.style.width = `${rect.width}px`;
          windowEl.style.height = `${rect.height}px`;
          resizeState = {
            startX: event.clientX,
            startY: event.clientY,
            startWidth: rect.width,
            startHeight: rect.height,
            left: rect.left - desktopRect.left,
            top: rect.top - desktopRect.top,
            mode: handle.dataset.resize || "corner",
          };
          setActiveWindow(windowEl.dataset.windowId);
          document.addEventListener("pointermove", onPointerMove);
          document.addEventListener("pointerup", onPointerUp);
        });
      });
    }

    function openToolWindow(tool) {
      const windowId = `win-${tool.title.toLowerCase().replace(/[^a-z0-9]+/g, "-")}`;
      const existing = windowMap.get(windowId);
      if (existing) {
        existing.window.style.display = "grid";
        setActiveWindow(windowId);
        return;
      }

      const appWindow = document.createElement("article");
      appWindow.className = "app-window";
      appWindow.dataset.windowId = windowId;
      appWindow.setAttribute("aria-label", `${tool.title} window`);

      const leftOffset = 60 + (openCount % 5) * 28;
      const topOffset = 38 + (openCount % 4) * 24;
      appWindow.style.left = `${leftOffset}px`;
      appWindow.style.top = `${topOffset}px`;
      openCount += 1;

      appWindow.innerHTML = `
        <div class="window-titlebar">
          <img class="title-icon" src="${fallbackIcon}" alt="" />
          <div class="window-title">${tool.title}${tool.experimental ? " [experimental]" : ""}</div>
          <div class="window-actions">
            <button class="win-btn win-open" type="button" title="Open in new tab">+</button>
            <button class="win-btn win-minimize" type="button" title="Minimize">-</button>
            <button class="win-btn win-close" type="button" title="Close">x</button>
          </div>
        </div>
        <div class="window-content">
          <iframe src="${tool.link}" loading="lazy" referrerpolicy="no-referrer"></iframe>
        </div>
        <div class="window-resizer window-resizer-right" data-resize="right" role="presentation"></div>
        <div class="window-resizer window-resizer-bottom" data-resize="bottom" role="presentation"></div>
        <div class="window-resizer window-resizer-corner" data-resize="corner" role="presentation"></div>
      `;

      const taskButton = document.createElement("button");
      taskButton.className = "task-button";
      taskButton.type = "button";
      taskButton.textContent = tool.title;
      taskButton.addEventListener("click", () => toggleMinimize(windowId));

      taskButtons.appendChild(taskButton);
      windowLayer.appendChild(appWindow);
      windowMap.set(windowId, { id: windowId, window: appWindow, taskButton });

      const titlebar = appWindow.querySelector(".window-titlebar");
      const closeBtn = appWindow.querySelector(".win-close");
      const minBtn = appWindow.querySelector(".win-minimize");
      const openBtn = appWindow.querySelector(".win-open");
      const titleIcon = appWindow.querySelector(".title-icon");
      const resizeHandles = appWindow.querySelectorAll(".window-resizer");

      attachDrag(appWindow, titlebar);
      attachResize(appWindow, resizeHandles);

      appWindow.addEventListener("mousedown", () => setActiveWindow(windowId));
      closeBtn.addEventListener("click", () => removeWindow(windowId));
      minBtn.addEventListener("click", () => toggleMinimize(windowId));
      openBtn.addEventListener("click", () => window.open(tool.link, "_blank", "noopener,noreferrer"));
      titleIcon.addEventListener("error", () => {
        titleIcon.src = fallbackIcon;
      });
      applyResolvedFavicon(titleIcon, tool.link);

      setActiveWindow(windowId);
    }

    function createDesktopIcon(tool) {
      const iconButton = document.createElement("button");
      iconButton.type = "button";
      iconButton.className = "desktop-icon";
      iconButton.title = `${tool.title}\n${tool.description}`;

      const label = tool.experimental ? `${tool.title} [exp]` : tool.title;
      iconButton.innerHTML = `
        <img src="${fallbackIcon}" alt="${tool.title} favicon" loading="lazy" />
        <span>${label}</span>
      `;

      const image = iconButton.querySelector("img");
      image.addEventListener("error", () => {
        image.src = fallbackIcon;
      });
      applyResolvedFavicon(image, tool.link);

      iconButton.addEventListener("dblclick", () => openToolWindow(tool));
      iconButton.addEventListener("click", () => {
        if (window.matchMedia("(pointer: coarse)").matches) {
          openToolWindow(tool);
        }
      });
      iconButton.addEventListener("keydown", (event) => {
        if (event.key === "Enter" || event.key === " ") {
          event.preventDefault();
          openToolWindow(tool);
        }
      });

      desktopIcons.appendChild(iconButton);
    }

    allTools.forEach((tool) => createDesktopIcon(tool));
    updateClock();
    setInterval(updateClock, 1000);
  </script>
</body>

</html>
