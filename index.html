<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>tools.jwd.me</title>
  <link rel="icon" type="image/svg+xml" href="./favicon.svg" />
  <link rel="shortcut icon" href="./favicon.svg" />
  <style>
    @font-face {
      font-family: "APL386";
      src: url("./APL386.ttf") format("truetype");
      font-style: normal;
      font-weight: 400;
      font-display: swap;
    }

    :root {
      --panel-bg: #e5e5e5;
      --panel-border: #000;
      --window-bg: #f1f1f1;
      --window-border: #000;
      --title-active-start: #f3f3f3;
      --title-active-end: #dcdcdc;
      --title-inactive-start: #ececec;
      --title-inactive-end: #e2e2e2;
      --text-dark: #101010;
      --shadow: rgba(0, 0, 0, 0.2);
      --icon-size: 58px;
    }

    * {
      box-sizing: border-box;
    }

    html,
    body {
      margin: 0;
      width: 100%;
      height: 100%;
      font-family: "APL386", "Geneva", "Helvetica", "Arial", sans-serif;
      color: var(--text-dark);
      overflow: hidden;
      user-select: none;
    }

    button,
    input,
    select,
    textarea {
      font: inherit;
    }

    body {
      background: #888 url("./bg.jpg") center / cover no-repeat;
      position: relative;
    }

    body::after {
      content: "";
      position: absolute;
      inset: 0;
      pointer-events: none;
      background-image: radial-gradient(rgba(0, 0, 0, 0.22) 0.6px, transparent 0.6px);
      background-size: 2px 2px;
      opacity: 0.32;
    }

    #desktop-shell {
      position: relative;
      width: 100%;
      height: 100%;
      display: grid;
      grid-template-rows: 36px 1fr;
      z-index: 1;
    }

    .panel {
      border: 2px solid var(--panel-border);
      background: linear-gradient(#f7f7f7, var(--panel-bg));
      box-shadow: inset 0 1px 0 #fff, 0 1px 2px rgba(0, 0, 0, 0.15);
      display: flex;
      align-items: center;
      padding: 0 10px;
      gap: 10px;
      font-size: 14px;
      font-weight: 700;
    }

    .panel-top {
      border-width: 0 0 2px;
    }

    .panel-menu {
      display: flex;
      gap: 4px;
    }

    .menu-item {
      border: 1px solid transparent;
      padding: 3px 7px;
      cursor: default;
      line-height: 1;
      transition: background 0.08s, color 0.08s;
      position: relative;
    }

    .menu-item:hover,
    .menu-item.active {
      border-color: #000;
      background: #000;
      color: #fff;
    }

    .menu-dropdown {
      display: none;
      position: absolute;
      top: 100%;
      left: -1px;
      background: #fff;
      border: 2px solid #000;
      box-shadow: 2px 2px 0 rgba(0,0,0,.5);
      min-width: 200px;
      z-index: 9999;
      padding: 2px 0;
    }

    .menu-item.active .menu-dropdown {
      display: block;
    }

    .menu-dropdown-item {
      padding: 3px 16px 3px 8px;
      cursor: default;
      white-space: nowrap;
      color: #000;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .menu-item-label {
      flex: 1;
      min-width: 0;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .menu-item-shortcut {
      margin-left: auto;
      width: 14px;
      height: 14px;
      border: 1px solid currentColor;
      border-radius: 2px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      line-height: 1;
      flex-shrink: 0;
      opacity: 0.85;
    }

    .menu-dropdown-item img {
      width: 16px;
      height: 16px;
      object-fit: contain;
      flex-shrink: 0;
    }

    .menu-dropdown-item:hover {
      background: #000;
      color: #fff;
    }

    .menu-apple {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding-inline: 8px;
    }

    .menu-apple img {
      width: 15px;
      height: 15px;
      object-fit: contain;
      display: block;
    }

    .panel-apps {
      flex: 1;
      min-width: 0;
      display: flex;
      align-items: center;
      gap: 2px;
      overflow-x: auto;
      scrollbar-width: none;
      padding: 2px 0;
    }

    .panel-apps::-webkit-scrollbar {
      display: none;
    }

    .panel-app-btn {
      display: flex;
      align-items: center;
      gap: 4px;
      border: 1px solid transparent;
      background: transparent;
      padding: 2px 8px 2px 4px;
      cursor: default;
      font: inherit;
      font-size: 12px;
      font-weight: 700;
      line-height: 1;
      white-space: nowrap;
      max-width: 140px;
      flex-shrink: 0;
    }

    .panel-app-btn img {
      width: 16px;
      height: 16px;
      object-fit: contain;
      flex-shrink: 0;
    }

    .panel-app-btn span {
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .panel-app-btn:hover {
      border-color: #000;
      background: rgba(255, 255, 255, 0.5);
    }

    .panel-app-btn.active {
      border-color: #000;
      background: #fff;
      box-shadow: inset 0 -2px 0 #000;
    }

    .panel-app-btn.minimized {
      border-color: #999;
      background: transparent;
      opacity: 0.65;
    }

    .panel-app-btn.minimized:hover {
      opacity: 1;
      border-color: #000;
    }

    .panel-clock {
      min-width: 160px;
      text-align: right;
      font-variant-numeric: tabular-nums;
      color: #171717;
      font-weight: 700;
    }

    #desktop {
      position: relative;
      width: 100%;
      height: 100%;
      overflow: hidden;
      padding: 18px;
    }

    .desktop-icons {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 16px 10px;
      max-width: 720px;
      pointer-events: auto;
    }

    .desktop-icon {
      width: 100px;
      border: 1px solid transparent;
      background: transparent;
      color: var(--text-dark);
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      padding: 8px 6px;
      cursor: default;
      outline: none;
      transition: border-color 0.1s, background 0.1s;
    }

    .desktop-icon:hover,
    .desktop-icon:focus-visible {
      border-color: #000;
      background:
        linear-gradient(45deg, rgba(0, 0, 0, 0.10) 25%, transparent 25%) 0 0 / 4px 4px,
        linear-gradient(-45deg, rgba(0, 0, 0, 0.06) 25%, transparent 25%) 0 0 / 4px 4px,
        rgba(255, 255, 255, 0.30);
    }

    .desktop-icon:active {
      background:
        linear-gradient(45deg, rgba(0, 0, 0, 0.18) 25%, transparent 25%) 0 0 / 4px 4px,
        linear-gradient(-45deg, rgba(0, 0, 0, 0.12) 25%, transparent 25%) 0 0 / 4px 4px,
        rgba(255, 255, 255, 0.20);
    }

    .desktop-icon img {
      width: var(--icon-size);
      height: var(--icon-size);
      object-fit: contain;
      pointer-events: none;
      filter: drop-shadow(3px 4px 5px rgba(0, 0, 0, 0.7));
    }

    .desktop-icon span {
      text-align: center;
      font-size: 12px;
      line-height: 1.3;
      width: fit-content;
      max-width: 100%;
      margin: 0 auto;
      padding: 2px 6px;
      word-break: break-word;
      color: #000;
      background: #fff;
      border: 2px solid #000;
      box-shadow: 2px 2px 0 rgba(0,0,0,.5);
    }

    .desktop-icon.blank-launch::after {
      content: "\2197";
      position: absolute;
      top: 10px;
      right: calc((100% - var(--icon-size)) / 2 - 2px);
      width: 17px;
      height: 17px;
      border: 2px solid #000;
      border-radius: 3px;
      background: #fff;
      color: #000;
      font-size: 12px;
      font-weight: 700;
      line-height: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 1px 1px 0 rgba(0, 0, 0, 0.35);
      pointer-events: none;
      z-index: 1;
    }

    .window-layer {
      position: absolute;
      inset: 0;
      pointer-events: none;
    }

    @keyframes windowOpen {
      from { opacity: 0; transform: scale(0.92); }
      to { opacity: 1; transform: scale(1); }
    }

    .app-window {
      position: absolute;
      width: min(540px, calc(100vw - 48px));
      height: min(400px, calc(100vh - 130px));
      min-width: 320px;
      min-height: 220px;
      border: 2px solid var(--window-border);
      background: var(--window-bg);
      box-shadow: 4px 4px 0 var(--shadow);
      display: grid;
      grid-template-rows: 34px 1fr;
      overflow: visible;
      pointer-events: auto;
      animation: windowOpen 0.15s ease-out;
    }

    .app-window.inactive {
      box-shadow: 3px 3px 0 rgba(0, 0, 0, 0.12);
    }

    .app-window.inactive .window-titlebar {
      background: linear-gradient(var(--title-inactive-start), var(--title-inactive-end));
    }

    .app-window.inactive .window-titlebar::after {
      opacity: 0;
    }

    .window-titlebar {
      background: linear-gradient(var(--title-active-start), var(--title-active-end));
      color: #000;
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 0 4px;
      font-size: 13px;
      border-bottom: 2px solid #000;
      cursor: move;
      position: relative;
    }

    .window-titlebar::after {
      content: "";
      position: absolute;
      inset: 6px 0;
      background: repeating-linear-gradient(
        to bottom,
        transparent 0px, transparent 1px,
        #000 1px, #000 2px
      );
      opacity: 0.12;
      pointer-events: none;
      z-index: 0;
      transition: opacity 0.15s;
    }

    .window-titlebar > * {
      position: relative;
      z-index: 1;
    }

    .title-icon {
      width: 18px;
      height: 18px;
      background: #fff;
      border: 2px solid #000;
      object-fit: contain;
      flex: 0 0 auto;
    }

    .window-title {
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-weight: 700;
      background: #efefef;
      border-block: 2px solid #000;
      line-height: 1.3;
      padding: 0 8px;
      text-align: center;
    }

    .window-actions {
      display: flex;
      align-items: center;
      gap: 4px;
      margin-left: auto;
    }

    .win-btn {
      width: 16px;
      height: 16px;
      border: 2px solid #000;
      background: #fff;
      color: #111;
      font-size: 9px;
      font-weight: 700;
      line-height: 1;
      padding: 0;
      cursor: pointer;
      display: grid;
      place-items: center;
      transition: background 0.08s, color 0.08s;
    }

    .win-btn:hover {
      background: #000;
      color: #fff;
    }

    .win-btn:active {
      background: #333;
      color: #fff;
    }

    .win-btn-min {
      font-size: 11px;
    }

    .window-content {
      position: relative;
      background: #fff;
      overflow: hidden;
    }

    .window-content iframe {
      width: 100%;
      height: 100%;
      border: 0;
      background: #fff;
    }

    .window-resizer {
      position: absolute;
      z-index: 6;
      touch-action: none;
    }

    .window-resizer-right {
      top: 34px;
      right: -10px;
      width: 10px;
      bottom: 0;
      cursor: ew-resize;
    }

    .window-resizer-bottom {
      left: 0;
      right: 0;
      bottom: -10px;
      height: 10px;
      cursor: ns-resize;
    }

    .window-resizer-corner {
      right: -12px;
      bottom: -12px;
      width: 34px;
      height: 34px;
      cursor: nwse-resize;
      border-top: 2px solid #000;
      border-left: 2px solid #000;
      background:
        repeating-linear-gradient(45deg, #f8f8f8 0 2px, #d6d6d6 2px 4px);
      z-index: 7;
      transition: background 0.1s;
    }

    .window-resizer-corner:hover {
      background:
        repeating-linear-gradient(45deg, #fff 0 2px, #c0c0c0 2px 4px);
    }

    @media (max-width: 900px) {
      .panel-app-btn span {
        display: none;
      }

      .panel-clock {
        min-width: 104px;
        font-size: 12px;
      }

      .desktop-icons {
        grid-template-columns: repeat(auto-fill, minmax(86px, 1fr));
        max-width: none;
      }

      .desktop-icon {
        width: auto;
      }

      .app-window {
        width: min(96vw, 520px);
        height: min(56vh, 400px);
      }
    }
  </style>
</head>

<body>
  <div id="desktop-shell">
    <header class="panel panel-top" role="banner">
      <div class="panel-menu" aria-label="Menu strip">
        <span class="menu-item menu-apple" aria-label="Project icon">
          <img src="./favicon.svg" alt="" />
        </span>
        <span class="menu-item" data-category="Audio & Music">Audio<div class="menu-dropdown"></div></span>
        <span class="menu-item" data-category="Games & Input">Games<div class="menu-dropdown"></div></span>
        <span class="menu-item" data-category="Image & Media">Image<div class="menu-dropdown"></div></span>
        <span class="menu-item" data-category="Text & Utility">Utility<div class="menu-dropdown"></div></span>
        <span class="menu-item" data-category="Misc">Misc<div class="menu-dropdown"></div></span>
      </div>
      <div class="panel-apps" id="panel-apps"></div>
      <div class="panel-clock" id="panel-clock" aria-live="polite"></div>
    </header>

    <main id="desktop">
      <section class="desktop-icons" id="desktop-icons" aria-label="Desktop icons"></section>
      <section class="window-layer" id="window-layer" aria-label="Open windows"></section>
    </main>
  </div>

  <script src="apps.js"></script>
  <script>

    const desktop = document.getElementById("desktop");
    const desktopIcons = document.getElementById("desktop-icons");
    const windowLayer = document.getElementById("window-layer");
    const panelClock = document.getElementById("panel-clock");
    const fallbackIcon = "./favicon.svg";
    let topZIndex = 30;
    let openCount = 0;
    const windowMap = new Map();
    const faviconRuntimeCache = new Map();
    const faviconPromiseCache = new Map();

    function faviconScope(url) {
      const parsed = new URL(url);
      const path = parsed.pathname.endsWith("/") ? parsed.pathname : `${parsed.pathname}/`;
      return `${parsed.origin}${path}`;
    }

    function faviconCacheKey(scope) {
      return `tools:favicon:v2:${encodeURIComponent(scope)}`;
    }

    function getCachedFavicon(scope) {
      try {
        return localStorage.getItem(faviconCacheKey(scope));
      } catch {
        return null;
      }
    }

    function setCachedFavicon(scope, iconUrl) {
      try {
        localStorage.setItem(faviconCacheKey(scope), iconUrl);
      } catch {
      }
    }

    function clearCachedFavicon(scope) {
      try {
        localStorage.removeItem(faviconCacheKey(scope));
      } catch {
      }
    }

    function faviconCandidates(url) {
      const { hostname, origin } = new URL(url);
      const scope = faviconScope(url);

      return [...new Set([
        `${scope}favicon.svg`,
        `${scope}favicon.ico`,
        `${scope}favicon.png`,
        `${origin}/favicon.svg`,
        `${origin}/favicon.ico`,
        `${origin}/favicon.png`,
        `${origin}/apple-touch-icon.png`,
        `https://icons.duckduckgo.com/ip3/${hostname}.ico`,
        `https://www.google.com/s2/favicons?domain=${hostname}&sz=128`,
      ])];
    }

    function preloadImage(url) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.decoding = "async";
        img.referrerPolicy = "no-referrer";
        img.onload = () => resolve(url);
        img.onerror = () => reject(new Error(`Icon load failed: ${url}`));
        img.src = url;
      });
    }

    function resolveFavicon(url) {
      let scope, origin;
      try {
        const parsed = new URL(url);
        origin = parsed.origin;
        scope = faviconScope(url);
      } catch {
        return Promise.resolve(fallbackIcon);
      }

      if (faviconRuntimeCache.has(scope)) {
        return Promise.resolve(faviconRuntimeCache.get(scope));
      }

      if (faviconPromiseCache.has(scope)) {
        return faviconPromiseCache.get(scope);
      }

      const pendingResolution = (async () => {
        const cachedIcon = getCachedFavicon(scope);
        if (cachedIcon && cachedIcon.startsWith(origin)) {
          try {
            await preloadImage(cachedIcon);
            faviconRuntimeCache.set(scope, cachedIcon);
            return cachedIcon;
          } catch {
            clearCachedFavicon(scope);
          }
        } else if (cachedIcon) {
          clearCachedFavicon(scope);
        }

        const candidates = faviconCandidates(url);
        for (const iconUrl of candidates) {
          try {
            await preloadImage(iconUrl);
            faviconRuntimeCache.set(scope, iconUrl);
            setCachedFavicon(scope, iconUrl);
            return iconUrl;
          } catch {
          }
        }
        faviconRuntimeCache.set(scope, fallbackIcon);
        return fallbackIcon;
      })();

      faviconPromiseCache.set(scope, pendingResolution);
      pendingResolution.finally(() => {
        faviconPromiseCache.delete(scope);
      });

      return pendingResolution;
    }

    function applyResolvedFavicon(imageEl, toolUrl) {
      imageEl.src = fallbackIcon;
      resolveFavicon(toolUrl).then((iconUrl) => {
        imageEl.src = iconUrl;
      });
    }

    function updateClock() {
      const now = new Date();
      const clock = now.toLocaleTimeString([], {
        hour: "numeric",
        minute: "2-digit",
        second: "2-digit",
      });
      const day = now.toLocaleDateString([], {
        weekday: "short",
        month: "short",
        day: "numeric",
      });
      panelClock.textContent = `${day} ${clock}`;
    }

    function setActiveWindow(windowId) {
      windowMap.forEach((entry, id) => {
        entry.window.classList.toggle("inactive", id !== windowId);
        if (entry.panelBtn) {
          entry.panelBtn.classList.toggle("active", id === windowId && !entry.minimized);
        }
      });

      const active = windowMap.get(windowId);
      if (active) {
        topZIndex += 1;
        active.window.style.zIndex = topZIndex;
      }
    }

    function minimizeWindow(windowId) {
      const entry = windowMap.get(windowId);
      if (!entry) return;
      entry.minimized = true;
      entry.window.style.display = "none";
      if (entry.panelBtn) {
        entry.panelBtn.classList.remove("active");
        entry.panelBtn.classList.add("minimized");
      }
      const newest = [...windowMap.values()]
        .filter((e) => !e.minimized)
        .sort((a, b) => Number(b.window.style.zIndex || 0) - Number(a.window.style.zIndex || 0))[0];
      if (newest) setActiveWindow(newest.id);
    }

    function restoreWindow(windowId) {
      const entry = windowMap.get(windowId);
      if (!entry) return;
      entry.minimized = false;
      entry.window.style.display = "grid";
      if (entry.panelBtn) {
        entry.panelBtn.classList.remove("minimized");
      }
      setActiveWindow(windowId);
    }

    function removeWindow(windowId) {
      const entry = windowMap.get(windowId);
      if (!entry) {
        return;
      }

      entry.window.remove();
      if (entry.panelBtn) entry.panelBtn.remove();
      windowMap.delete(windowId);

      const newest = [...windowMap.values()]
        .filter((e) => !e.minimized)
        .sort((a, b) => Number(b.window.style.zIndex || 0) - Number(a.window.style.zIndex || 0))[0];
      if (newest) {
        setActiveWindow(newest.id);
      }
    }

    function attachDrag(windowEl, dragHandle) {
      let dragState = null;

      const onPointerMove = (event) => {
        if (!dragState) {
          return;
        }

        const desktopRect = desktop.getBoundingClientRect();
        const maxLeft = desktopRect.width - windowEl.offsetWidth;
        const maxTop = desktopRect.height - windowEl.offsetHeight;
        const left = Math.min(Math.max(0, event.clientX - dragState.offsetX), Math.max(0, maxLeft));
        const top = Math.min(Math.max(0, event.clientY - desktopRect.top - dragState.offsetY), Math.max(0, maxTop));
        windowEl.style.left = `${left}px`;
        windowEl.style.top = `${top}px`;
      };

      const onPointerUp = () => {
        dragState = null;
        document.removeEventListener("pointermove", onPointerMove);
        document.removeEventListener("pointerup", onPointerUp);
      };

      dragHandle.addEventListener("pointerdown", (event) => {
        if (event.target.closest(".win-btn")) {
          return;
        }

        const rect = windowEl.getBoundingClientRect();
        const desktopRect = desktop.getBoundingClientRect();
        dragState = {
          offsetX: event.clientX - rect.left,
          offsetY: event.clientY - rect.top,
        };
        windowEl.style.top = `${rect.top - desktopRect.top}px`;
        setActiveWindow(windowEl.dataset.windowId);
        document.addEventListener("pointermove", onPointerMove);
        document.addEventListener("pointerup", onPointerUp);
      });
    }

    function attachResize(windowEl, resizeHandles) {
      let resizeState = null;

      const onPointerMove = (event) => {
        if (!resizeState) {
          return;
        }

        const desktopRect = desktop.getBoundingClientRect();
        const maxWidth = desktopRect.width - resizeState.left;
        const maxHeight = desktopRect.height - resizeState.top;
        if (resizeState.mode === "right" || resizeState.mode === "corner") {
          const nextWidth = Math.max(320, Math.min(maxWidth, resizeState.startWidth + (event.clientX - resizeState.startX)));
          windowEl.style.width = `${nextWidth}px`;
        }

        if (resizeState.mode === "bottom" || resizeState.mode === "corner") {
          const nextHeight = Math.max(220, Math.min(maxHeight, resizeState.startHeight + (event.clientY - resizeState.startY)));
          windowEl.style.height = `${nextHeight}px`;
        }
      };

      const onPointerUp = () => {
        resizeState = null;
        document.removeEventListener("pointermove", onPointerMove);
        document.removeEventListener("pointerup", onPointerUp);
      };

      resizeHandles.forEach((handle) => {
        handle.addEventListener("pointerdown", (event) => {
          event.preventDefault();
          event.stopPropagation();
          const rect = windowEl.getBoundingClientRect();
          const desktopRect = desktop.getBoundingClientRect();
          windowEl.style.width = `${rect.width}px`;
          windowEl.style.height = `${rect.height}px`;
          resizeState = {
            startX: event.clientX,
            startY: event.clientY,
            startWidth: rect.width,
            startHeight: rect.height,
            left: rect.left - desktopRect.left,
            top: rect.top - desktopRect.top,
            mode: handle.dataset.resize || "corner",
          };
          setActiveWindow(windowEl.dataset.windowId);
          document.addEventListener("pointermove", onPointerMove);
          document.addEventListener("pointerup", onPointerUp);
        });
      });
    }

    function openToolWindow(tool) {
      if (tool.blank) {
        window.open(tool.link, "_blank", "noopener,noreferrer");
        return;
      }

      const windowId = `win-${tool.title.toLowerCase().replace(/[^a-z0-9]+/g, "-")}`;
      const existing = windowMap.get(windowId);
      if (existing) {
        if (existing.minimized) {
          restoreWindow(windowId);
        } else {
          setActiveWindow(windowId);
        }
        return;
      }

      const appWindow = document.createElement("article");
      appWindow.className = "app-window";
      appWindow.dataset.windowId = windowId;
      appWindow.setAttribute("aria-label", `${tool.title} window`);

      const leftOffset = 60 + (openCount % 5) * 28;
      const topOffset = 38 + (openCount % 4) * 24;
      appWindow.style.left = `${leftOffset}px`;
      appWindow.style.top = `${topOffset}px`;
      openCount += 1;
      const iframeAllowAttr = tool.iframeAllow ? ` allow="${tool.iframeAllow}"` : "";

      appWindow.innerHTML = `
        <div class="window-titlebar">
          <img class="title-icon" src="${fallbackIcon}" alt="" />
          <div class="window-title">${tool.title}</div>
          <div class="window-actions">
            <button class="win-btn win-btn-min win-minimize" type="button" title="Minimize">&#8211;</button>
            <button class="win-btn win-open" type="button" title="Open in new tab">+</button>
            <button class="win-btn win-close" type="button" title="Close">x</button>
          </div>
        </div>
        <div class="window-content">
          <iframe src="${tool.link}" title="${tool.title}" loading="lazy" referrerpolicy="no-referrer"${iframeAllowAttr}></iframe>
        </div>
        <div class="window-resizer window-resizer-right" data-resize="right" role="presentation"></div>
        <div class="window-resizer window-resizer-bottom" data-resize="bottom" role="presentation"></div>
        <div class="window-resizer window-resizer-corner" data-resize="corner" role="presentation"></div>
      `;

      windowLayer.appendChild(appWindow);

      const panelBtn = document.createElement("button");
      panelBtn.type = "button";
      panelBtn.className = "panel-app-btn active";
      panelBtn.dataset.windowId = windowId;
      panelBtn.innerHTML = `<img src="${fallbackIcon}" alt="" /><span>${tool.title}</span>`;
      const panelBtnIcon = panelBtn.querySelector("img");
      applyResolvedFavicon(panelBtnIcon, tool.link);
      document.getElementById("panel-apps").appendChild(panelBtn);

      windowMap.set(windowId, { id: windowId, window: appWindow, panelBtn, minimized: false });

      const titlebar = appWindow.querySelector(".window-titlebar");
      const closeBtn = appWindow.querySelector(".win-close");
      const openBtn = appWindow.querySelector(".win-open");
      const minimizeBtn = appWindow.querySelector(".win-minimize");
      const titleIcon = appWindow.querySelector(".title-icon");
      const resizeHandles = appWindow.querySelectorAll(".window-resizer");

      attachDrag(appWindow, titlebar);
      attachResize(appWindow, resizeHandles);

      appWindow.addEventListener("mousedown", () => setActiveWindow(windowId));
      closeBtn.addEventListener("click", () => removeWindow(windowId));
      openBtn.addEventListener("click", () => window.open(tool.link, "_blank", "noopener,noreferrer"));
      minimizeBtn.addEventListener("click", () => minimizeWindow(windowId));
      panelBtn.addEventListener("click", () => {
        const entry = windowMap.get(windowId);
        if (!entry) return;
        if (entry.minimized) {
          restoreWindow(windowId);
        } else if (appWindow.classList.contains("inactive")) {
          setActiveWindow(windowId);
        } else {
          minimizeWindow(windowId);
        }
      });
      titleIcon.addEventListener("error", () => {
        titleIcon.src = fallbackIcon;
      });
      applyResolvedFavicon(titleIcon, tool.link);

      setActiveWindow(windowId);
    }

    function createDesktopIcon(tool) {
      const iconButton = document.createElement("button");
      iconButton.type = "button";
      iconButton.className = "desktop-icon";
      iconButton.title = `${tool.title}\n${tool.description}`;
      if (tool.blank) {
        iconButton.classList.add("blank-launch");
        iconButton.title = `${tool.title}\n${tool.description}\nOpens in a new tab`;
      }

      iconButton.innerHTML = `
        <img src="${fallbackIcon}" alt="${tool.title} favicon" loading="lazy" />
        <span>${tool.title}</span>
      `;

      const image = iconButton.querySelector("img");
      image.addEventListener("error", () => {
        image.src = fallbackIcon;
      });
      applyResolvedFavicon(image, tool.link);

      iconButton.addEventListener("dblclick", () => openToolWindow(tool));
      iconButton.addEventListener("click", () => {
        if (window.matchMedia("(pointer: coarse)").matches) {
          openToolWindow(tool);
        }
      });
      iconButton.addEventListener("keydown", (event) => {
        if (event.key === "Enter" || event.key === " ") {
          event.preventDefault();
          openToolWindow(tool);
        }
      });

      desktopIcons.appendChild(iconButton);
    }

    [...tools].sort((a, b) => (a.blank ? 1 : 0) - (b.blank ? 1 : 0)).forEach(createDesktopIcon);
    updateClock();
    setInterval(updateClock, 1000);

    document.querySelectorAll(".menu-item[data-category]").forEach((menuItem) => {
      const category = menuItem.dataset.category;
      const dropdown = menuItem.querySelector(".menu-dropdown");
      const categoryTools = tools
        .filter((t) => t.category === category)
        .sort((a, b) => a.title.localeCompare(b.title));
      categoryTools.forEach((tool) => {
        const item = document.createElement("div");
        item.className = "menu-dropdown-item";
        const icon = document.createElement("img");
        const label = document.createElement("span");
        label.className = "menu-item-label";
        label.textContent = tool.title;
        icon.src = fallbackIcon;
        icon.alt = "";
        resolveFavicon(tool.link).then((src) => { icon.src = src; });
        item.appendChild(icon);
        item.appendChild(label);
        if (tool.blank) {
          const shortcut = document.createElement("span");
          shortcut.className = "menu-item-shortcut";
          shortcut.textContent = "\u2197";
          shortcut.setAttribute("aria-hidden", "true");
          item.appendChild(shortcut);
          item.title = `${tool.title} (opens in a new tab)`;
        }
        item.addEventListener("click", (e) => {
          e.stopPropagation();
          openToolWindow(tool);
          closeMenus();
        });
        dropdown.appendChild(item);
      });

      menuItem.addEventListener("click", (e) => {
        e.stopPropagation();
        const wasActive = menuItem.classList.contains("active");
        closeMenus();
        if (!wasActive) menuItem.classList.add("active");
      });

      menuItem.addEventListener("mouseenter", () => {
        if (document.querySelector(".menu-item.active")) {
          closeMenus();
          menuItem.classList.add("active");
        }
      });
    });

    function closeMenus() {
      document.querySelectorAll(".menu-item.active").forEach((el) => el.classList.remove("active"));
    }

    document.addEventListener("click", closeMenus);
  </script>
</body>

</html>
